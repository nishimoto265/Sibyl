metadata:
  generated_at_utc: "2025-11-01T09:56:00Z"
  author: codex-cli
  language: "ja"
  source_summary: >
    CLI上で複数のコーディングエージェントを並列稼働させ、最終的にBossエージェントが
    出力を評価・統合できるOSSを開発する。
現在の状況:
  ステータス: "要件定義中"
  未解決事項:
    - "エージェントが利用する具体的なLLMやエンジンの選定"
    - "Bossエージェントの採点アルゴリズム・指標の詳細"
    - "フォーク後に取得した新セッションIDの記録・共有方式"
概要:
  目標: >
    同一指示を複数エージェントへ同時配信し、その成果をBossエージェントが評価・統合する
    開発支援CLIツールを提供する。
  成功指標:
    - "1コマンドでN個のエージェント環境（tmux + git worktree）を立ち上げられること。"
    - "各エージェントのログを詳細に取得し、障害箇所を追跡できること。"
    - "Bossエージェントが任意のエージェント成果物を選択・統合し、継続作業に接続できること。"
  並列起動フロー:
    - "ユーザーはメインCodexセッションに指示を送る。"
    - "Orchestratorは直近のユーザー指示を捕捉し、メインセッションを即時中断する。"
    - "保存した指示を用い、各ワークツリー用tmuxセッションで同一セッションをresumeし、自動フォーク（Esc操作送信）で独立セッションIDを得る。"
    - "独立した各セッションへ指示を再送し、並列エージェントを起動する。"
詳細フロー:
  前提:
    - "起動時に`parallel-dev` CLIが依頼内容を受信し、内部で `/done` 指示を含むテンプレートへ整形する。"
    - "メインCodexは空の状態から指示を受け取り、Escで中断される。worker Codexはフォークされた履歴を持ち、同じ指示で再開する。"
    - "Boss Codexは評価用に起動し、後工程で採用案を統合する役割を持つ。"
  手順:
    - "CLIがワークツリーを準備：`.parallel-dev/worktrees/worker-N` を生成し、各worker用に切り替える。"
    - "tmuxレイアウトを作成し、メイン/Boss/worker*Nペインに `codex` コマンドを送信。"
    - "メインペインに指示を送信し、Escで中断→`codex resume` で履歴を保持。"
    - "CodexMonitorがメインセッションIDを記録し、workerペインへフォーク後の新セッションIDが登録されるまで監視。"
    - "workerペインで `codex resume <session_id>` を実行し、指示（`/done`含む）を再送。各workerは完了時に `/done` を出力。"
    - "CodexMonitorが `/done` を検出したセッションから順に完了扱いとし、全worker分揃ったら次工程へ進める。"
    - "Bossエージェント（または補助スクリプト）が各workerと自分の成果物を評価し、`score` と `comment` を生成、`logs/<timestamp>/cycles/*.yaml` へ記録。"
    - "CLIがスコアボード（例: `worker-1 80`, `worker-2 50`, `boss 90`）と詳細を表示。ユーザーは採用案（worker or boss）を入力する。"
    - "採用案がworkerの場合：該当worktreeの差分を main ワークツリーへマージ。Bossの場合：Bossが統合したworktree内容を main へマージ。"
    - "メインペインで`codex resume <採用セッションID>` を送信し、次サイクルの開始状態を整える。"
    - "ログ一式（sessions_map.yaml, cycles/*.yaml, instruction.log）を保存し、CLIは処理結果を表示して終了。"
  評価・採用フロー:
    - "全workerおよびBoss案を対象に、成果物・ログ・セッション情報からスコア（例: 0〜100）とコメントを算出する。"
    - "スコアは自動評価が基本（例: `/done`検知 + git差分サイズ + エラー有無などを指標化）とし、必要なら追加コメントを付与できる。"
    - "CLIはスコアボード（例: worker1 80, worker2 50, boss 90）と詳細情報を表示し、ユーザーに採用案を選択させるUIを提供する。"
    - "選択された案のワークツリー内容をmainワークツリーへマージする。必要に応じてBoss案は統合済みの成果を使う。"
    - "採用したセッションIDをメインCodexで`codex resume <id>`して、次サイクルの作業を継続できる状態にする。"
主なインターフェース:
  cli:
    目的: "指示受付・パイプライン制御・結果承認を一元化するフロントエンド。将来的にGUIへ移行できるAPI設計を前提とする。"
    機能:
      - "指示入力コマンド（例: `parallel-dev prompt \"...\"`）でメインCodexへ送信。"
      - "tmuxレイアウト管理（セッション1個 + メイン/Boss/worker*Nペイン、Nのデフォルトは3）。"
      - "ワークフロー状態遷移管理（指示受付→フォーク展開→完了検知→Boss採点→ユーザー選択→mainマージ→次サイクル）。"
      - "REST/IPC化を見据えた内部APIを提供し、将来的なGUI接続を想定。"
tmuxレイアウト:
  セッション: "1つのtmuxセッションにメインCodex、Boss Codex、worker*Nの計N+2ペインを配置。"
  デフォルトN: 3
  ペイン役割:
    - "メイン: 指示を受け取る専用。"
    - "Boss: 評価・統合・マージを行う。"
    - "worker: 並列開発を担当。必要に応じて追加生成・終了が可能。"
ログ設計:
  - "tmux各ペインの履歴は`logs/<タイムスタンプ>/<role>.log`に収集する。"
  - "Codexのrollout JSONLは`logs/<タイムスタンプ>/sessions/<session_id>.jsonl`へコピー。"
  - "CLIイベントログを`logs/<タイムスタンプ>/cli.log`に出力し、開始/終了ステージ・採点結果・エラーを記録。"
  - "Boss評価結果や採点シートは`logs/<タイムスタンプ>/boss_eval.yaml`にまとめる。"
完了検知方式:
  - "各workerはタスク完了時に必ず`/done`メッセージを送信する（AGENTS.mdやプロンプトで厳守させる）。"
  - "CLIはCodexのrollout JSONLを常時監視し、`/done`を検出したworkerを完了とみなす。すべてのworkerで検出できた時点でBossフェーズへ遷移する。"
  - "一定時間内に`/done`が揃わない場合のみCLIがユーザーへ確認ダイアログ（CLI上のプロンプト）を提示し、手動で待機/中断を選択できるようにする。"
セッションID取得:
 - "フォーク後、CLIは~/.codex/sessions/YYYY/MM/DD/配下のファイルイベントを監視し、新規に生成されたrollout-*.jsonlの先頭行（SessionMeta）をパースして`id`値を取得する。"
  - "ファイル名に含まれるUUIDとSessionMeta内のIDを照合し、一致確認後にセッションIDとして採用する。"
  - "監視が失敗した場合の冗長経路として、対象ペイン上で`codex resume --last --json`を実行し、JSON出力の`conversation_id`を抽出する。"
  - "取得したIDは`logs/<タイムスタンプ>/sessions_map.yaml`にメインIDとの対応表として保存し、各worker ID → JSONLパス → git worktreeパスを紐づける。"
  - "Bossが採用したセッションをメインに昇格させる際は、このMapを用いて対象セッションのJSONL・worktree・ペインIDを逆引きし、必要に応じてメインペインで`codex resume <採用ID>`を再起動する。"
機能要件:
  - id: F-001
    内容: "CLIコマンドでタスク指示を作成し、N個のエージェントに同時ブロードキャストする。"
  - id: F-002
    内容: "各エージェントごとに独立したgit worktreeを生成・管理する。"
  - id: F-003
    内容: "tmuxセッション（またはペイン）上でエージェントを起動し、resumeで文脈を保持する。"
  - id: F-004
    内容: "エージェントごとの詳細ログを生成し、トラブルシュートを容易にする。"
  - id: F-005
    内容: "Bossエージェントが成果物を閲覧し、スコアリング・統合方針を決定できるUI/コマンドを備える。"
  - id: F-006
    内容: "Bossエージェントが採用案をmainワークツリーにマージし、メインCodexで再び指示を出せるようにする。"
  - id: F-007
    内容: "メインセッションで取得したユーザー指示を自動的に保存・中断し、フォーク済み各セッションへ再送する制御機構を提供する。"
  - id: F-008
    内容: "tmuxレイアウト（メイン/Boss/worker*N）の生成・破棄・再配置をCLIから一括操作できるようにする。"
  - id: F-009
    内容: "Codex JSONLから`/done`メッセージを検出し、全worker完了時にBossフェーズへ遷移するワークフロー制御を実装する。"
  - id: F-010
    内容: "フォーク後に生成された各セッションIDを自動取得し、ログとBoss統合プロセスに関連付ける。"
  - id: F-011
    内容: "HELLO文字列を標準出力する単純なスクリプトを提供し、TTDでテスト可能な形で維持する。"
成果物:
  - "CLI実装コードとテスト（TTDベース）。"
  - "セットアップ・利用方法・ログ方針を説明するドキュメント。"
  - "複数エージェント起動スクリプト、tmux制御スクリプト、Boss用統合ツール。"
留意事項:
  - "区切りのタイミングでgitコミットし、docs/experiment.yamlに活動ログを記録する。"
  - "手動で判断して要件を変更する際は、事前に依頼者の承認を得る。"
