weekly_flow:
  - week: 1
    label: 初回サイクル
    steps:
      - "1. CLIアプリケーションを起動する。"
      - "2. 現在時刻からセッションIDを生成する。"
      - "3. セッションIDを基にtmuxセッション名を決定する。"
      - "4. logs/<session-id> ディレクトリを作成する。"
      - "5. 初期ステータスを待機中として表示する。"
      - "6. ユーザーから最初の指示テキストを受信する。"
      - "7. サイクル用のログディレクトリ logs/<session-id>/<yy-mm-dd-hhmmss> を作成する。"
      - "8. tmux制御・ワークツリー・Codex監視・ログ管理の各オブジェクトを初期化する。"
      - "9. tmuxセッションで必要なペインレイアウトを確認する。"
      - "10. 不足しているペインを分割してメイン/Boss/ワーカー構成を整える。"
      - "11. `.parallel-dev/worktrees` を作成または再利用する。"
      - "12. 各ワーカー用ディレクトリ `.parallel-dev/worktrees/worker-N` を再生成する。"
      - "13. Boss用ディレクトリ `.parallel-dev/boss` を再生成する。"
      - "14. tmuxメインペインで `codex` コマンドを実行する。"
      - "15. 指示文の末尾に `/done` 指示文を追記する。"
      - "16. 追記済み指示文をメインペインにペーストする。"
      - "17. メインペインへ Ctrl+C を二回送信してCodexを停止する。"
      - "18. 新しく生成されたrolloutファイルからメインセッションIDを取得する。"
      - "19. メインセッションIDとpaneの対応情報を保存する。"
      - "20. 各ワーカーペインへ Ctrl+C を二回送信する。"
      - "21. 各ワーカーペインに `codex resume <main-id>` を送信する。"
      - "22. 各ワーカーペインに Esc を二回送信する。"
      - "23. 各ワーカーペインに Enter を送信してフォーク完了を確定する。"
      - "24. ワーカーの新しいrolloutファイルが現れるまで待機する。"
      - "25. 新しいrolloutからワーカーのセッションIDを取得する。"
      - "26. ワーカーセッションIDをpane情報と紐づける。"
      - "27. 監視処理が全ワーカーの `/done` を検知するまで待機する。"
      - "27a. ワーカー完了時に `/continue` を送ればステップ20〜27を再実行でき、`/done` を送れば次工程へ進む。"
      - "28. ワーカー完了ステータスをログへ書き出す。"
      - "29. Bossペインに Ctrl+C を送信して待機状態にする。"
      - "30. Bossペインに `codex resume <main-id>` を送信する。"
      - "31. Bossペインに Esc を二回送信する。"
      - "32. Bossペインに Enter を送信して独立セッションにフォークする。"
      - "33. 新しいBossセッションIDを取得する。"
      - "34. ワーカー候補一覧と採点手順を含む評価指示文を生成する。"
      - "35. 評価指示文をBossペインへ送信する。"
      - "36. Bossセッションの `/done` を検知するまで待機する。"
      - "37. Bossレスポンスを取得する。"
      - "38. BossレスポンスのJSONを解析する。"
      - "39. score と comment を候補ごとに抽出する。"
      - "40. ワーカー完了情報とBossスコアを統合したスコアボードを組み立てる。"
      - "41. 候補一覧とスコアボードをUIへ送信する。"
      - "42. ユーザーの採択選択を待機する。"
      - "43. 選択された候補のブランチをmainへfast-forwardマージする。"
      - "44. 選択されたセッションIDでメインペインに `codex resume` を送信する。"
      - "45. サイクルの指示・tmux配置・完了情報・スコアボードをYAML/JSONLへ記録する。"
      - "46. 会話ログパスやセッションIDを含むマニフェストを保存する。"
      - "47. 実行状態を待機中に戻す。"
      - "48. スコアボードと採択結果を履歴に追加する。"
      - "49. 第1週目のサイクルを完了と宣言する。"
  - week: 2
    label: 2回目以降のサイクル
    steps:
      - "1. 1.6の手順で次のユーザー指示テキストを受信する。"
      - "2. 前回サイクルで採択したセッションIDとtmuxセッション名を保持する。"
      - "3. 1.7〜1.49の手順を順に再実行し、ログ準備から記録保存まで第1サイクルと同じ処理を行う。"

esc_behavior:
  description: "ESCキー操作の共通ルール"
  rules:
    - "ESCを1回押すとCLIControllerが一時停止モードへ入り、全ペインへEscapeをブロードキャストしてCodex入力を中断させる。"
    - "一時停止中に再度ESCを押すと直前に採択された `_last_selected_session` をメインに戻し、進行中サイクルをキャンセルする。"
    - "巻き戻し後に再開する際はステップ15から同じ手順（Ctrl+C×2 → `codex resume <_last_selected_session>` → `/done`付き指示投入）を繰り返す。"

continue_behavior:
  description: "ワーカー完了後の分岐"
  rules:
    - "ワーカーが `/done` を返した直後は `/continue` でステップ20〜27へ戻り追加作業を指示できる。"
    - "同じ場面で `/done` を送ると従来どおりBoss評価（ステップ28以降）へ進む。"
